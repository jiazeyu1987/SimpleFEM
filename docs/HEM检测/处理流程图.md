# SimpleFEM 处理流程图

## 整体系统架构流程

```mermaid
graph TB
    A[程序启动] --> B[加载配置文件]
    B --> C{处理模式?}

    C -->|screen| D[屏幕实时捕获模式]
    C -->|video| E[视频文件处理模式]

    D --> F[初始化屏幕捕获]
    E --> G[初始化视频播放器]

    F --> H[主处理循环开始]
    G --> H

    H --> I[获取图像帧]
    I --> J[ROI1区域提取]
    J --> K[绿线交点检测]
    K --> L{检测到交点?}

    L -->|是| M[ROI2区域提取]
    L -->|否| N[记录无交点状态]

    M --> O[计算ROI2灰度值]
    N --> P[跳过此帧处理]

    O --> Q[更新循环缓冲区]
    Q --> R[自适应阈值计算]
    R --> S[波峰区域检测]
    S --> T[绿/红波峰分类]
    T --> U[数据去重处理]
    U --> V[统计与CSV导出]
    V --> W{保存图像数据?}

    W -->|是| X[保存ROI1/ROI2/波形]
    W -->|否| Y[仅记录日志]

    X --> Z[帧率控制等待]
    Y --> Z
    P --> Z

    Z --> AA{继续运行?}
    AA -->|是| I
    AA -->|否| BB[程序结束]

    BB --> CC[导出最终CSV]
    CC --> DD[资源清理]
    DD --> EE[程序退出]
```

## 绿线检测算法流程

```mermaid
graph TB
    A[ROI1彩色图像] --> B[转换到HSV颜色空间]
    B --> C[绿色范围过滤]
    C --> D[二值化掩码生成]
    D --> E[Canny边缘检测]
    E --> F[霍夫直线变换]
    F --> G{检测到线段?}

    G -->|否| H[返回None]
    G -->|是| I[按线段长度排序]
    I --> J[选择两条主线段]
    J --> K{两条线平行?}

    K -->|是| L[寻找其他角度线段]
    K -->|否| M[计算线段交点]

    L --> N{找到合适线段?}
    N -->|否| H
    N -->|是| M

    M --> O{交点在图像内?}
    O -->|否| H
    O -->|是| P[返回交点坐标]
```

## 波峰检测算法流程

```mermaid
graph TB
    A[灰度值序列] --> B[背景均值更新]
    B --> C{启用自适应阈值?}

    C -->|是| D[计算自适应阈值]
    C -->|否| E[使用固定阈值]

    D --> F[阈值确定]
    E --> F
    F --> G[扫描连续高位区间]
    G --> H[原始波峰区间列表]
    H --> I[应用最小间隔过滤]
    I --> J[应用静默约束]
    J --> K[最终波峰区间]
    K --> L[计算前后均值差]
    L --> M{差值 >= 判定阈值?}

    M -->|是| N[分类为绿色波峰]
    M -->|否| O[分类为红色波峰]

    N --> P[绿峰列表]
    O --> Q[红峰列表]
    P --> R[返回检测结果]
    Q --> R
```

## 自适应阈值计算流程

```mermaid
graph TB
    A[当前帧灰度值] --> B{当前值 < 当前阈值?}

    B -->|否| C[跳过背景更新]
    B -->|是| D[更新背景累加值]

    D --> E[背景样本计数+1]
    E --> F{样本数 >= 最小要求?}

    F -->|否| G[使用固定阈值]
    F -->|是| H[计算背景均值]

    H --> I[自适应阈值 = 背景均值 × (1 + 上浮比例)]
    I --> J[返回自适应阈值]
    G --> K[返回固定阈值]

    C --> L[保持当前阈值]
    L --> M[返回当前阈值]
```

## 数据统计与去重流程

```mermaid
graph TB
    A[新检测的波峰] --> B[检查去重窗口]
    B --> C{存在相似波峰?}

    C -->|否| D[添加到统计列表]
    C -->|是| E[比较波峰强度]

    E --> F{新波峰更强?}
    F -->|是| G[替换旧波峰]
    F -->|否| H[丢弃新波峰]

    D --> I[更新会话统计]
    G --> I
    H --> I

    I --> J[检查导出条件]
    J --> K{满足导出条件?}

    K -->|是| L[生成CSV记录]
    K -->|否| M[继续等待]

    L --> N[写入CSV文件]
    N --> O[更新文件索引]
    M --> P[处理完成]
    O --> P
```

## 资源管理与错误处理流程

```mermaid
graph TB
    A[程序运行] --> B{发生异常?}

    B -->|否| C[正常处理循环]
    B -->|是| D[异常类型判断]

    D --> E{KeyboardInterrupt?}
    D --> F{视频处理错误?}
    D --> G{图像处理错误?}
    D --> H{其他运行时错误?}

    E -->|是| I[优雅停止处理]
    F -->|是| J[视频错误处理]
    G -->|是| K[图像错误处理]
    H -->|是| L[通用错误处理]

    I --> M[导出最终数据]
    J --> N[尝试重新打开视频]
    K --> O[跳过当前帧]
    L --> P[记录错误日志]

    M --> Q[释放视频资源]
    N --> R{重试成功?}
    O --> C
    P --> C

    R -->|是| C
    R -->|否| S[视频结束处理]

    Q --> T[清理OpenCV窗口]
    S --> U[程序退出]
    T --> U
```

## 配置加载与优先级流程

```mermaid
graph TB
    A[程序启动] --> B[读取JSON配置文件]
    B --> C[加载默认配置]
    C --> D[扫描环境变量]
    D --> E{存在NHEM_*环境变量?}

    E -->|是| F[覆盖对应配置项]
    E -->|否| G[使用JSON配置]
    F --> H[配置合并完成]
    G --> H

    H --> I[配置验证]
    I --> J{配置有效?}

    J -->|是| K[应用配置]
    J -->|否| L[使用安全默认值]

    K --> M[程序正常运行]
    L --> N[记录配置警告]
    N --> M
```

这些流程图详细展示了 SimpleFEM 系统的各个处理阶段，为理解系统工作原理和排查问题提供了可视化的参考。